<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tolki - Versione Free</title>
  <style>
    /* --- CSS come da te fornito (non modificato) --- */
    /* ... tutto il tuo CSS qui ... */
  </style>
</head>
<body>

  <header>
    <h1>Tolki, il tuo assistente virtuale da viaggio</h1>
    <div class="header-buttons">
      <button class="btn-pro" id="goProBtn" title="Passa a Pro">Passa a Pro</button>
      <button class="btn-settings" id="openSettings" title="Impostazioni">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="container">
    <!-- Tutto il contenuto come nel tuo codice originale -->
    <label for="langFrom">Lingua originale</label>
    <select id="langFrom">
      <option value="en">Inglese</option>
      <option value="it" selected>Italiano</option>
      <option value="fr">Francese</option>
      <option value="es">Spagnolo</option>
      <option value="de">Tedesco</option>
    </select>

    <label for="langTo">Lingua di destinazione</label>
    <select id="langTo">
      <option value="it">Italiano</option>
      <option value="en" selected>Inglese</option>
      <option value="fr">Francese</option>
      <option value="es">Spagnolo</option>
      <option value="de">Tedesco</option>
    </select>

    <label for="inputText">Testo da tradurre</label>
    <textarea id="inputText" placeholder="Scrivi o parla..."></textarea>

    <div class="btn-row">
      <button id="startMic" class="small-btn">üé§ Inizia</button>
      <button id="stopMic" class="small-btn" disabled>‚èπÔ∏è Ferma</button>
      <button id="translateBtn" class="small-btn">üîÑ Traduci</button>
      <button id="speakBtn" class="small-btn">üîà Leggi</button>
    </div>

    <label for="outputText">Testo tradotto</label>
    <textarea id="outputText" readonly placeholder="Risultato..."></textarea>

    <div id="savedTranslations">
      <h3>Traduzioni Salvate Oggi</h3>
      <ul id="translationsList"></ul>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h3>Impostazioni</h3>
      <button id="logoutBtn">üö™ Logout</button>
      <button onclick="document.getElementById('settingsModal').style.display='none'">Chiudi</button>
    </div>
  </div>

<script>
  // CONTROLLA LOGIN
  const loggedInUser = localStorage.getItem('loggedInUser');
  if (!loggedInUser) {
    window.location.href = 'login.html';
  } else {
    console.log('Utente loggato:', loggedInUser);
  }

  // Tutto il tuo JS originale, senza modifiche se non dove indicato

  const inputText = document.getElementById('inputText');
  const outputText = document.getElementById('outputText');
  const langFrom = document.getElementById('langFrom');
  const langTo = document.getElementById('langTo');
  const translateBtn = document.getElementById('translateBtn');
  const speakBtn = document.getElementById('speakBtn');
  const startMic = document.getElementById('startMic');
  const stopMic = document.getElementById('stopMic');

  const openSettings = document.getElementById('openSettings');
  const settingsModal = document.getElementById('settingsModal');
  const logoutBtn = document.getElementById('logoutBtn');
  const goProBtn = document.getElementById('goProBtn');

  const savedTranslationsDiv = document.getElementById('savedTranslations');
  const translationsList = document.getElementById('translationsList');

  openSettings.onclick = () => settingsModal.style.display = 'flex';
  logoutBtn.onclick = () => {
    localStorage.removeItem('loggedInUser');
    window.location.href = 'login.html';
  };

  goProBtn.onclick = () => {
    window.location.href = 'pro.html';
  };

  // Speech Recognition
  let recognition;
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
  } else if ('SpeechRecognition' in window) {
    recognition = new SpeechRecognition();
  }

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      inputText.value = event.results[0][0].transcript;
    };
    recognition.onstart = () => {
      startMic.disabled = true;
      stopMic.disabled = false;
    };
    recognition.onend = () => {
      startMic.disabled = false;
      stopMic.disabled = true;
    };
    recognition.onerror = () => {
      startMic.disabled = false;
      stopMic.disabled = true;
    };
  }

  startMic.onclick = () => {
    if (recognition) {
      recognition.lang = langFrom.value;
      recognition.start();
    }
  };

  stopMic.onclick = () => {
    if (recognition) recognition.stop();
  };

  function getTodayDate() {
    const d = new Date();
    return d.toISOString().split('T')[0];
  }

  function loadSavedTranslations() {
    const today = getTodayDate();
    let savedData = localStorage.getItem('savedTranslations');
    if (!savedData) return [];

    try {
      const allSaved = JSON.parse(savedData);
      if (allSaved.date !== today) {
        localStorage.removeItem('savedTranslations');
        return [];
      }
      return allSaved.translations || [];
    } catch {
      localStorage.removeItem('savedTranslations');
      return [];
    }
  }

  function saveTranslations(translations) {
    const today = getTodayDate();
    localStorage.setItem('savedTranslations', JSON.stringify({
      date: today,
      translations: translations
    }));
  }

  function renderSavedTranslations() {
    translationsList.innerHTML = '';
    const translations = loadSavedTranslations();
    if (translations.length === 0) {
      translationsList.innerHTML = '<li>Nessuna traduzione salvata oggi.</li>';
      return;
    }
    translations.forEach(t => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${t.input}</strong> <span class="lang-label">‚Üí ${t.output}</span>
        <span class="lang-label">${t.from.toUpperCase()} ‚Üí ${t.to.toUpperCase()}</span>
      `;
      translationsList.appendChild(li);
    });
  }

  translateBtn.onclick = async () => {
    const text = inputText.value.trim();
    if (!text) return alert("Inserisci del testo.");
    outputText.value = "Sto traducendo...";
    try {
      const res = await fetch(`https://lingva.ml/api/v1/${langFrom.value}/${langTo.value}/${encodeURIComponent(text)}`);
      const data = await res.json();
      outputText.value = data.translation;

      let saved = loadSavedTranslations();
      if (saved.length < 20) {
        saved.push({
          input: text,
          output: data.translation,
          from: langFrom.value,
          to: langTo.value
        });
        saveTranslations(saved);
        renderSavedTranslations();
      } else {
        alert("Hai raggiunto il limite di 20 traduzioni salvate oggi.");
      }
    } catch (e) {
      outputText.value = "Errore durante la traduzione.";
    }
  };

  speakBtn.onclick = () => {
    const text = outputText.value.trim();
    if (!text) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langTo.value;
    speechSynthesis.speak(utterance);
  };

  renderSavedTranslations();

</script>
</body>
</html>
