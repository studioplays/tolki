<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tolki - Versione Free</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #0078D7;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Pulsante ‚ÄúPassa a Pro‚Äù leggermente pi√π grande */
    .btn-pro {
      background-color: #ff9800;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      padding: 6px 14px;
      border-radius: 14px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 100px;
      text-align: center;
      transition: background-color 0.2s ease;
    }
    .btn-pro:hover {
      background-color: #e68900;
    }

    /* Pulsante Impostazioni piccolo */
    .btn-settings {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 4px 6px;
      line-height: 1;
      border-radius: 8px;
      transition: background-color 0.2s ease;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-settings:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .container {
      max-width: 600px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    label {
      margin-top: 15px;
      display: block;
      font-weight: 600;
    }
    select, textarea, button {
      width: 100%;
      margin-top: 8px;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .small-btn {
      flex: 1;
      font-size: 0.9rem;
      padding: 10px;
      background-color: #0078D7;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }
    .small-btn:disabled {
      background-color: #999;
    }

    /* Popup settings */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      max-width: 300px;
    }
    .modal-content button {
      margin-top: 10px;
    }

    /* --- NUOVA GRAFICA TRADUZIONI SALVATE --- */
    #savedTranslations {
      margin-top: 30px;
      background: #f9fafb;
      padding: 20px 25px;
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.95rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      border: 1px solid #ddd;
    }

    #savedTranslations h3 {
      margin-top: 0;
      font-weight: 700;
      color: #0078D7;
      margin-bottom: 15px;
      font-size: 1.25rem;
      border-bottom: 2px solid #0078D7;
      padding-bottom: 5px;
    }

    #translationsList {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    #translationsList li {
      background: white;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: background-color 0.3s ease;
      cursor: default;
    }

    #translationsList li:hover {
      background-color: #e6f0fc;
    }

    #translationsList li span.lang-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: #555;
      margin-left: 8px;
      background: #e0eaff;
      padding: 2px 6px;
      border-radius: 6px;
    }

    #translationsList li .translation-text {
      display: block;
      margin-top: 5px;
      color: #222;
      font-weight: 500;
    }
  </style>
</head>
<body>

  <header>
    <h1>Tolki, il tuo assistente virtuale da viaggio</h1>
    <div class="header-buttons">
      <button class="btn-pro" id="goProBtn" title="Passa a Pro">Passa a Pro</button>
      <button class="btn-settings" id="openSettings" title="Impostazioni">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="container">
    <label for="langFrom">Lingua originale</label>
    <select id="langFrom">
      <option value="en">Inglese</option>
      <option value="it" selected>Italiano</option>
      <option value="fr">Francese</option>
      <option value="es">Spagnolo</option>
      <option value="de">Tedesco</option>
    </select>

    <label for="langTo">Lingua di destinazione</label>
    <select id="langTo">
      <option value="it">Italiano</option>
      <option value="en" selected>Inglese</option>
      <option value="fr">Francese</option>
      <option value="es">Spagnolo</option>
      <option value="de">Tedesco</option>
    </select>

    <label for="inputText">Testo da tradurre</label>
    <textarea id="inputText" placeholder="Scrivi o parla..."></textarea>

    <div class="btn-row">
      <button id="startMic" class="small-btn">üé§ Inizia</button>
      <button id="stopMic" class="small-btn" disabled>‚èπÔ∏è Ferma</button>
      <button id="translateBtn" class="small-btn">üîÑ Traduci</button>
      <button id="speakBtn" class="small-btn">üîà Leggi</button>
    </div>

    <label for="outputText">Testo tradotto</label>
    <textarea id="outputText" readonly placeholder="Risultato..."></textarea>

    <!-- NUOVA SEZIONE TRADUZIONI SALVATE -->
    <div id="savedTranslations">
      <h3>Traduzioni Salvate Oggi</h3>
      <ul id="translationsList"></ul>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h3>Impostazioni</h3>
      <button id="logoutBtn">üö™ Logout</button>
      <button onclick="document.getElementById('settingsModal').style.display='none'">Chiudi</button>
    </div>
  </div>

<script>
  const inputText = document.getElementById('inputText');
  const outputText = document.getElementById('outputText');
  const langFrom = document.getElementById('langFrom');
  const langTo = document.getElementById('langTo');
  const translateBtn = document.getElementById('translateBtn');
  const speakBtn = document.getElementById('speakBtn');
  const startMic = document.getElementById('startMic');
  const stopMic = document.getElementById('stopMic');

  const openSettings = document.getElementById('openSettings');
  const settingsModal = document.getElementById('settingsModal');
  const logoutBtn = document.getElementById('logoutBtn');
  const goProBtn = document.getElementById('goProBtn');

  const savedTranslationsDiv = document.getElementById('savedTranslations');
  const translationsList = document.getElementById('translationsList');

  openSettings.onclick = () => settingsModal.style.display = 'flex';
  logoutBtn.onclick = () => {
    localStorage.removeItem('loggedInUser');
    window.location.href = 'login.html';
  };

  goProBtn.onclick = () => {
    window.location.href = 'pro.html';
  };

  // Speech Recognition
  let recognition;
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
  } else if ('SpeechRecognition' in window) {
    recognition = new SpeechRecognition();
  }

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      inputText.value = event.results[0][0].transcript;
    };
    recognition.onstart = () => {
      startMic.disabled = true;
      stopMic.disabled = false;
    };
    recognition.onend = () => {
      startMic.disabled = false;
      stopMic.disabled = true;
    };
    recognition.onerror = () => {
      startMic.disabled = false;
      stopMic.disabled = true;
    };
  }

  startMic.onclick = () => {
    if (recognition) {
      recognition.lang = langFrom.value;
      recognition.start();
    }
  };

  stopMic.onclick = () => {
    if (recognition) recognition.stop();
  };

  // Funzione per ottenere la data in formato YYYY-MM-DD
  function getTodayDate() {
    const d = new Date();
    return d.toISOString().split('T')[0];
  }

  // Carica traduzioni salvate per oggi da localStorage
  function loadSavedTranslations() {
    const today = getTodayDate();
    let savedData = localStorage.getItem('savedTranslations');
    if (!savedData) return [];

    try {
      const allSaved = JSON.parse(savedData);
      if (allSaved.date !== today) {
        localStorage.removeItem('savedTranslations');
        return [];
      }
      return allSaved.translations || [];
    } catch {
      localStorage.removeItem('savedTranslations');
      return [];
    }
  }

  // Salva traduzioni per oggi in localStorage
  function saveTranslations(translations) {
    const today = getTodayDate();
    localStorage.setItem('savedTranslations', JSON.stringify({
      date: today,
      translations: translations
    }));
  }

  // Aggiorna la UI con le traduzioni salvate
  function renderSavedTranslations() {
    translationsList.innerHTML = '';
    const translations = loadSavedTranslations();
    if (translations.length === 0) {
      translationsList.innerHTML = '<li>Nessuna traduzione salvata oggi.</li>';
      return;
    }
    translations.forEach(t => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${t.input}</strong> <span class="lang-label">‚Üí ${t.output}</span>
        <span class="lang-label">${t.from.toUpperCase()} ‚Üí ${t.to.toUpperCase()}</span>
      `;
      translationsList.appendChild(li);
    });
  }

  translateBtn.onclick = async () => {
    const text = inputText.value.trim();
    if (!text) return alert("Inserisci del testo.");
    outputText.value = "Sto traducendo...";
    try {
      const res = await fetch(`https://lingva.ml/api/v1/${langFrom.value}/${langTo.value}/${encodeURIComponent(text)}`);
      const data = await res.json();
      outputText.value = data.translation;

      let saved = loadSavedTranslations();
      if (saved.length < 20) {
        saved.push({
          input: text,
          output: data.translation,
          from: langFrom.value,
          to: langTo.value
        });
        saveTranslations(saved);
        renderSavedTranslations();
      } else {
        alert("Hai raggiunto il limite di 20 traduzioni salvate oggi.");
      }
    } catch (e) {
      outputText.value = "Errore durante la traduzione.";
    }
  };

  speakBtn.onclick = () => {
    const text = outputText.value.trim();
    if (!text) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langTo.value;
    speechSynthesis.speak(utterance);
  };

  renderSavedTranslations();

  if (!localStorage.getItem('loggedInUser')) {
    window.location.href = 'login.html';
  }
</script>
</body>
</html>
