<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Social Moderno - Profilo & Discussioni Separate</title>
<style>
  /* Reset base */
  * {
    box-sizing: border-box;
  }
  body {
    margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e9f2fc;
    color: #333;
  }

  header {
    background-color: #4a90e2;
    color: white;
    padding: 1rem 2rem;
    font-size: 1.6rem;
    font-weight: 700;
    text-align: center;
    letter-spacing: 1.2px;
  }

  nav {
    display: flex;
    justify-content: center;
    background: #6aa0f8;
    gap: 1rem;
  }
  nav button {
    background: transparent;
    border: none;
    color: white;
    padding: 0.8rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s;
    border-radius: 6px 6px 0 0;
  }
  nav button.active, nav button:hover {
    background-color: #4a7dd4;
  }

  main {
    max-width: 900px;
    margin: 2rem auto;
    background: white;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 8px 15px rgb(74 144 226 / 0.3);
  }

  /* PROFILO */
  #profilePage {
    display: none;
  }
  #profilePage.active {
    display: block;
  }

  .profile-header {
    display: flex;
    align-items: center;
    gap: 2rem;
    border-bottom: 2px solid #4a90e2;
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
  }

  .profile-pic-container {
    position: relative;
    width: 130px;
    height: 130px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid #4a90e2;
    cursor: pointer;
  }
  .profile-pic-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .profile-pic-container input[type="file"] {
    display: none;
  }
  .profile-pic-container:hover::after {
    content: "Modifica Foto";
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: rgba(74, 144, 226, 0.8);
    color: white;
    font-size: 0.9rem;
    text-align: center;
    padding: 0.3rem 0;
  }

  .profile-info {
    flex: 1;
  }

  .profile-info h2 {
    margin: 0 0 0.3rem 0;
    font-size: 2rem;
    color: #2b4f90;
  }
  .profile-info small {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #4a90e2;
  }

  .profile-info textarea {
    width: 100%;
    font-family: inherit;
    font-size: 1rem;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    border: 1.8px solid #4a90e2;
    resize: vertical;
    min-height: 60px;
    margin-bottom: 1rem;
  }
  .profile-info input[type="text"] {
    font-size: 1.1rem;
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    border: 1.8px solid #4a90e2;
    width: 100%;
    max-width: 280px;
    margin-bottom: 1rem;
  }

  .btn-primary {
    background-color: #4a90e2;
    border: none;
    padding: 0.7rem 1.8rem;
    color: white;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.25s;
  }
  .btn-primary:hover {
    background-color: #3463b9;
  }

  /* Followers */
  .followers-container {
    margin-top: 1.5rem;
    border-top: 1px solid #cbd6ea;
    padding-top: 1rem;
  }
  .followers-count {
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #4a90e2;
  }
  .followers-list {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
  }
  .follower-badge {
    background-color: #d7e5fc;
    padding: 0.3rem 0.7rem;
    border-radius: 14px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #2b4f90;
  }

  /* Foto pubblicate (griglia Instagram-style) */
  .photo-grid {
    margin-top: 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(110px,1fr));
    gap: 10px;
  }
  .photo-grid-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 3px 7px rgb(74 144 226 / 0.3);
    cursor: pointer;
    background: white;
    transition: transform 0.2s ease;
  }
  .photo-grid-item:hover {
    transform: scale(1.05);
  }
  .photo-grid-item img {
    width: 100%;
    height: 110px;
    object-fit: cover;
    display: block;
  }

  /* Like overlay */
  .like-overlay {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(74, 144, 226, 0.8);
    color: white;
    padding: 4px 9px;
    border-radius: 20px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 4px;
    user-select: none;
  }

  /* DISCUSSIONI */
  #discussionsPage {
    display: none;
  }
  #discussionsPage.active {
    display: block;
  }

  #discussionNewForm {
    border-bottom: 2px solid #4a90e2;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
  }

  #discussionNewForm input[type="text"],
  #discussionNewForm textarea {
    width: 100%;
    font-family: inherit;
    font-size: 1rem;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    border: 1.8px solid #4a90e2;
    resize: vertical;
    margin-bottom: 1rem;
  }
  #discussionNewForm input[type="file"] {
    margin-bottom: 1rem;
  }

  #discussionNewForm button {
    background-color: #4a90e2;
    border: none;
    padding: 0.7rem 1.5rem;
    color: white;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.25s;
  }
  #discussionNewForm button:hover {
    background-color: #3463b9;
  }

  #discussionSearch {
    width: 100%;
    font-size: 1rem;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    border: 1.8px solid #4a90e2;
    margin-bottom: 1.5rem;
  }

  .discussion-list {
    display: flex;
    flex-direction: column;
    gap: 1.8rem;
  }
  .discussion-card {
    border-radius: 10px;
    box-shadow: 0 5px 12px rgb(74 144 226 / 0.15);
    padding: 1rem 1.3rem;
    background: white;
  }
  .discussion-card h3 {
    margin: 0 0 0.3rem 0;
    color: #2b4f90;
  }
  .discussion-card .discussion-author {
    font-weight: 600;
    color: #4a90e2;
    margin-bottom: 0.7rem;
  }
  .discussion-card .discussion-text {
    white-space: pre-wrap;
    margin-bottom: 1rem;
  }
  .discussion-card .discussion-images {
    display: flex;
    gap: 8px;
    margin-bottom: 1rem;
  }
  .discussion-card .discussion-images img {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    box-shadow: 0 3px 7px rgb(74 144 226 / 0.3);
    transition: transform 0.15s ease;
  }
  .discussion-card .discussion-images img:hover {
    transform: scale(1.1);
  }
  .discussion-interactions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 0.6rem;
  }
  .discussion-interactions button {
    background: none;
    border: none;
    font-size: 1.15rem;
    cursor: pointer;
    color: #4a90e2;
    display: flex;
    align-items: center;
    gap: 5px;
    user-select: none;
    transition: color 0.2s ease;
  }
  .discussion-interactions button:hover {
    color: #2b4f90;
  }
  .discussion-comments {
    border-top: 1px solid #cbd6ea;
    padding-top: 0.7rem;
    max-height: 150px;
    overflow-y: auto;
  }
  .discussion-comment {
    font-size: 0.9rem;
    padding: 0.3rem 0;
    border-bottom: 1px solid #e4e9f5;
  }
  .discussion-comment strong {
    color: #4a90e2;
  }

  .comment-form {
    margin-top: 0.7rem;
    display: flex;
    gap: 0.5rem;
  }
  .comment-form input[type="text"] {
    flex: 1;
    padding: 0.5rem 0.7rem;
    border-radius: 6px;
    border: 1.8px solid #4a90e2;
    font-size: 1rem;
  }
  .comment-form button {
    background-color: #4a90e2;
    border: none;
    padding: 0.55rem 1rem;
    color: white;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s;
  }
  .comment-form button:hover {
    background-color: #3463b9;
  }

  /* Responsive */
  @media (max-width: 520px) {
    .profile-header {
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    .profile-info input[type="text"],
    .profile-info textarea {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<header>Social Moderno</header>

<nav role="tablist" aria-label="Navigazione principale">
  <button id="tabProfileBtn" role="tab" aria-selected="true" tabindex="0" aria-controls="profilePage" class="active">Profilo</button>
  <button id="tabDiscussionsBtn" role="tab" aria-selected="false" tabindex="-1" aria-controls="discussionsPage">Discussioni</button>
</nav>

<main>
  <!-- PROFILO -->
  <section id="profilePage" role="tabpanel" aria-labelledby="tabProfileBtn" class="active" tabindex="0">

    <div class="profile-header">
      <label for="profilePicInput" class="profile-pic-container" title="Clicca per cambiare foto profilo" tabindex="0" role="button" aria-label="Cambia foto profilo">
        <img id="profilePic" src="https://via.placeholder.com/130?text=Profilo" alt="Foto profilo" />
        <input type="file" id="profilePicInput" accept="image/*" aria-label="Carica nuova foto profilo" />
      </label>
      <div class="profile-info">
        <input type="text" id="profileUsername" maxlength="20" placeholder="Nome utente unico" aria-describedby="usernameHelp" />
        <small id="usernameHelp">Nome utente unico, obbligatorio</small>
        <textarea id="profileBio" placeholder="Scrivi una breve bio... (max 150 caratteri)" maxlength="150" rows="3" aria-label="Bio personale"></textarea>
        <button class="btn-primary" id="saveProfileBtn" aria-label="Salva profilo">Salva Profilo</button>
      </div>
    </div>

    <div class="followers-container" aria-live="polite" aria-atomic="true">
      <div class="followers-count" id="followersCount">Follower: 0</div>
      <div class="followers-list" id="followersList" aria-label="Lista follower"></div>
    </div>

    <section aria-label="Foto pubblicate" id="photoGallery" class="photo-grid" role="list">
      <!-- Foto pubblicate dall'utente -->
    </section>

    <div style="margin-top: 1.5rem;">
      <label for="uploadPhotosInput" style="font-weight: 600; color: #4a90e2; cursor: pointer;">Carica foto nuove (max 5):</label>
      <input type="file" id="uploadPhotosInput" accept="image/*" multiple aria-label="Carica foto profilo" />
    </div>
  </section>

  <!-- DISCUSSIONI -->
  <section id="discussionsPage" role="tabpanel" aria-labelledby="tabDiscussionsBtn" tabindex="0">
    <input type="text" id="discussionSearch" placeholder="Cerca discussioni per titolo..." aria-label="Cerca discussioni" />

    <form id="discussionNewForm" aria-label="Nuova discussione">
      <input type="text" id="discussionTitle" placeholder="Titolo discussione (obbligatorio)" required aria-required="true" />
      <textarea id="discussionText" placeholder="Scrivi il contenuto della discussione..." rows="3"></textarea>
      <input type="file" id="discussionImages" accept="image/*" multiple aria-label="Carica immagini per discussione" />
      <button type="submit">Avvia Discussione</button>
    </form>

    <div id="discussionList" class="discussion-list" aria-live="polite" aria-atomic="true">
      <!-- Discussioni elencate qui -->
    </div>
  </section>
</main>

<script>
(() => {
  // --- Utility ---
  function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
  }
  function loadData(key, defaultValue) {
    const val = localStorage.getItem(key);
    return val ? JSON.parse(val) : defaultValue;
  }
  function isUsernameUnique(username, currentUsername) {
    const profiles = loadData('allProfiles', []);
    return !profiles.some(p => p.username.toLowerCase() === username.toLowerCase() && p.username.toLowerCase() !== currentUsername.toLowerCase());
  }

  // --- PROFILE DATA ---
  let profile = loadData('userProfile', {
    username: '',
    bio: '',
    profilePic: 'https://via.placeholder.com/130?text=Profilo',
    photos: [],
    followers: []
  });

  // --- ALL PROFILES for uniqueness check ---
  // Dummy profiles for demo followers
  let allProfiles = loadData('allProfiles', [
    { username: 'alice' },
    { username: 'bob' },
    { username: 'carlo' },
    { username: 'daniela' },
  ]);

  // Save current profile in allProfiles if new username
  function updateAllProfiles() {
    const idx = allProfiles.findIndex(p => p.username.toLowerCase() === profile.username.toLowerCase());
    if (idx === -1 && profile.username) {
      allProfiles.push({ username: profile.username });
    } else if (idx !== -1) {
      allProfiles[idx].username = profile.username;
    }
    saveData('allProfiles', allProfiles);
  }

  // --- DOM Elements ---
  const tabProfileBtn = document.getElementById('tabProfileBtn');
  const tabDiscussionsBtn = document.getElementById('tabDiscussionsBtn');

  const profilePage = document.getElementById('profilePage');
  const discussionsPage = document.getElementById('discussionsPage');

  const profilePicInput = document.getElementById('profilePicInput');
  const profilePicImg = document.getElementById('profilePic');

  const profileUsernameInput = document.getElementById('profileUsername');
  const profileBioInput = document.getElementById('profileBio');
  const saveProfileBtn = document.getElementById('saveProfileBtn');

  const followersCountElem = document.getElementById('followersCount');
  const followersListElem = document.getElementById('followersList');

  const photoGallery = document.getElementById('photoGallery');
  const uploadPhotosInput = document.getElementById('uploadPhotosInput');

  const discussionSearch = document.getElementById('discussionSearch');
  const discussionNewForm = document.getElementById('discussionNewForm');
  const discussionTitleInput = document.getElementById('discussionTitle');
  const discussionTextInput = document.getElementById('discussionText');
  const discussionImagesInput = document.getElementById('discussionImages');
  const discussionList = document.getElementById('discussionList');

  // --- NAVIGATION ---
  function switchTab(tab) {
    if (tab === 'profile') {
      tabProfileBtn.classList.add('active');
      tabProfileBtn.setAttribute('aria-selected', 'true');
      tabProfileBtn.tabIndex = 0;

      tabDiscussionsBtn.classList.remove('active');
      tabDiscussionsBtn.setAttribute('aria-selected', 'false');
      tabDiscussionsBtn.tabIndex = -1;

      profilePage.classList.add('active');
      discussionsPage.classList.remove('active');
      profilePage.focus();
    } else {
      tabDiscussionsBtn.classList.add('active');
      tabDiscussionsBtn.setAttribute('aria-selected', 'true');
      tabDiscussionsBtn.tabIndex = 0;

      tabProfileBtn.classList.remove('active');
      tabProfileBtn.setAttribute('aria-selected', 'false');
      tabProfileBtn.tabIndex = -1;

      discussionsPage.classList.add('active');
      profilePage.classList.remove('active');
      discussionsPage.focus();
    }
  }

  tabProfileBtn.addEventListener('click', () => switchTab('profile'));
  tabDiscussionsBtn.addEventListener('click', () => switchTab('discussions'));

  // --- PROFILE FUNCTIONS ---
  function renderProfile() {
    profilePicImg.src = profile.profilePic || 'https://via.placeholder.com/130?text=Profilo';
    profileUsernameInput.value = profile.username || '';
    profileBioInput.value = profile.bio || '';

    renderFollowers();
    renderPhotoGallery();
  }

  function renderFollowers() {
    const followers = profile.followers || [];
    followersCountElem.textContent = `Follower: ${followers.length}`;
    followersListElem.innerHTML = '';
    followers.forEach(f => {
      const span = document.createElement('span');
      span.className = 'follower-badge';
      span.textContent = f;
      followersListElem.appendChild(span);
    });
  }

  function renderPhotoGallery() {
    photoGallery.innerHTML = '';
    if (!profile.photos || profile.photos.length === 0) {
      photoGallery.innerHTML = '<p style="color:#999; text-align:center;">Nessuna foto pubblicata</p>';
      return;
    }
    profile.photos.forEach((photoDataUrl, i) => {
      const div = document.createElement('div');
      div.className = 'photo-grid-item';
      const img = document.createElement('img');
      img.src = photoDataUrl;
      img.alt = `Foto pubblicata #${i + 1}`;
      div.appendChild(img);
      photoGallery.appendChild(div);
    });
  }

  // Salvataggio foto profilo
  profilePicInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('image/')) return alert('Per favore seleziona un file immagine valido');
    const reader = new FileReader();
    reader.onload = () => {
      profile.profilePic = reader.result;
      profilePicImg.src = reader.result;
    };
    reader.readAsDataURL(file);
  });

  // Salvataggio foto pubblicate profilo
  uploadPhotosInput.addEventListener('change', e => {
    const files = Array.from(e.target.files);
    if (files.length + (profile.photos?.length || 0) > 5) {
      alert('Puoi caricare massimo 5 foto totali');
      return;
    }
    files.forEach(file => {
      if (!file.type.startsWith('image/')) {
        alert('Solo immagini sono ammesse');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        profile.photos = profile.photos || [];
        profile.photos.unshift(reader.result);
        saveProfile();
        renderPhotoGallery();
      };
      reader.readAsDataURL(file);
    });
    uploadPhotosInput.value = ''; // reset input
  });

  // Salvataggio dati profilo
  function saveProfile() {
    saveData('userProfile', profile);
    updateAllProfiles();
    renderFollowers();
  }

  saveProfileBtn.addEventListener('click', () => {
    const usernameVal = profileUsernameInput.value.trim();
    const bioVal = profileBioInput.value.trim();

    if (!usernameVal) {
      alert('Il nome utente è obbligatorio');
      return;
    }
    if (!isUsernameUnique(usernameVal, profile.username)) {
      alert('Nome utente già utilizzato, scegline un altro');
      return;
    }
    profile.username = usernameVal;
    profile.bio = bioVal;
    saveProfile();
    alert('Profilo salvato con successo!');
  });

  // --- DISCUSSIONS ---
  let discussions = loadData('discussions', []);

  // Salvataggio discussioni
  function saveDiscussions() {
    saveData('discussions', discussions);
  }

  // Render discussioni filtrate
  function renderDiscussions(filter = '') {
    const filterLc = filter.toLowerCase();
    discussionList.innerHTML = '';
    let filtered = discussions;
    if (filter) {
      filtered = discussions.filter(d => d.title.toLowerCase().includes(filterLc));
    }
    if (filtered.length === 0) {
      discussionList.innerHTML = '<p style="color:#666; text-align:center;">Nessuna discussione trovata</p>';
      return;
    }
    filtered.forEach((disc, index) => {
      const card = document.createElement('article');
      card.className = 'discussion-card';
      card.setAttribute('tabindex', '0');
      card.innerHTML = `
        <h3>${disc.title}</h3>
        <p>${disc.content}</p>
        ${disc.images?.length > 0 ? disc.images.map(img => `<img src="${img}" alt="Immagine discussione">`).join('') : ''}
      `;
      discussionList.appendChild(card);
    });
  }

  discussionSearch.addEventListener('input', () => {
    renderDiscussions(discussionSearch.value);
  });

  discussionNewForm.addEventListener('submit', e => {
    e.preventDefault();
    const title = discussionTitleInput.value.trim();
    const content = discussionTextInput.value.trim();

    if (!title) {
      alert('Il titolo della discussione è obbligatorio');
      return;
    }

    let imagesData = [];
    const files = Array.from(discussionImagesInput.files);
    if (files.length > 0) {
      let loadedCount = 0;
      imagesData = [];
      files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = () => {
          imagesData.push(reader.result);
          loadedCount++;
          if (loadedCount === files.length) {
            addDiscussion(title, content, imagesData);
          }
        };
        reader.readAsDataURL(file);
      });
    } else {
      addDiscussion(title, content, []);
    }
  });

  function addDiscussion(title, content, images) {
    discussions.unshift({ title, content, images });
    saveDiscussions();
    renderDiscussions(discussionSearch.value);
    discussionNewForm.reset();
  }

  // --- INITIAL LOAD ---
  renderProfile();
  renderDiscussions();

  // Start on profile tab
  switchTab('profile');
})();
</script>
</body>
</html>
